---
title: "Data_Recoding"
author: "Ayishat Yussuf"
date: "2025-09-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
```
# Load Packages and Datasets

```{r}
library(readr) #read in csv files 
library(survey) #analysis for survey data (e.g NHANES)
library(magrittr) #pip operations (%>%) 
library(dplyr) #data manipulation (filter, select, mutate etc) 
library(ggplot2) #creating data visualizations/plots
```

#Load File
```{r}
FullData_allcycles<-read.csv("~/Documents/Github/Phenols-Analysis/Phenols_DataClean/FullData_allcycles.csv")
```

##Food Security
```{r}
#fsdhh
table(FullData_allcycles$FSDHH, useNA="ifany")
#305 missing

#Variables
FullData_allcycles<-FullData_allcycles%>%
  mutate(FOODSEC=case_when(
    FSDHH==1 ~1,  #fully food secure (ref)
    FSDHH==2 ~2, #marginally food secure (1-2)
    FSDHH==3 ~3, # low food security 
    FSDHH==4 ~4,  #very low food security 
    TRUE~NA_real_
  ))

table(FullData_allcycles$FOODSEC,useNA="ifany")
```

##Age
```{r}
summary(FullData_allcycles$RIDAGEYR, useNA="ifany")

class(FullData_allcycles$RIDAGEYR) #to see what type of variable you have 

FullData_allcycles<-FullData_allcycles%>%
  filter(FullData_allcycles$RIDAGEYR>=18) #filtered for observations Age greater than or equal to 18

quartiles<-quantile(FullData_allcycles$RIDAGEYR)
print(quartiles)

FullData_allcyclesFINAL$AGEGROUP<-cut(
  FullData_allcyclesFINAL$RIDAGEYR,
  breaks=quartiles, 
  include.lowest=TRUE, 
  labels= c("18-31", "32-46", "47-63", "64-85")
)

summary(FullData_allcyclesFINAL$AGEQ, useNA="ifany") 
#no missing
table(FullData_allcycles$AGEGROUP, useNA="ifany")
```
decided to keep male as reference - september 19th, 2025

##Sex
```{r}
table(FullData_allcycles$RIAGENDR, useNA="ifany")

FullData_allcycles<-FullData_allcycles%>%
  mutate(SEX=ifelse(RIAGENDR==1, 1, 2))

levels(FullData_allcycles$SEX)<-(c("1", "2"))

table(FullData_allcycles$SEX, useNA="ifany")
```


##Race/Eth
```{r}
#Recode race/ethnicity 
table(FullData_allcycles$RIDRETH1, useNA="ifany")

FullData_allcycles<-FullData_allcycles%>%
  mutate(RACEETH=case_when(
    RIDRETH1==3 ~1,
    RIDRETH1==4 ~2, 
    RIDRETH1==1 ~3, 
    RIDRETH1==2 ~4, 
    RIDRETH1==5 ~5, 
    TRUE~NA_real_
  ))


table(FullData_allcycles$RACEETH, useNA="ifany")
```


##Education
```{r}
#education 
summary(FullData_allcycles$DMDEDUC3)
summary(FullData_allcycles$DMDEDUC3)
FullData_allcycles <- FullData_allcycles %>%
  mutate(EDUCAT = case_when(
   DMDEDUC3< 13 & RIDAGEYR<20 ~ 1,
    DMDEDUC2 < 3 ~ 1, 
    DMDEDUC2== 1 ~2, 
    DMDEDUC3 %in% c(13, 14, 15) ~ 2, 
    DMDEDUC2 == 3 ~ 2,
    DMDEDUC2 == 4 ~ 3,
    DMDEDUC2 == 5 ~ 4,
    TRUE ~ NA_real_
  ))

table(FullData_allcycles$EDUCAT, useNA="ifany")
```


##Poverty
```{r}
#poverty
summary(FullData_allcycles$INDFMPIR, useNA="ifany") #1513missing

FullData_allcycles<-FullData_allcycles%>%
  mutate(PIRCAT=case_when(
    INDFMPIR<=0.99 ~1, 
    INDFMPIR>=1 & INDFMPIR<2 ~2, 
    INDFMPIR>=2 & INDFMPIR<3 ~3, 
    INDFMPIR>=3 & INDFMPIR<5 ~4, 
    INDFMPIR>=5 ~5, 
    is.na(INDFMPIR)~NA_real_
  ))

table(FullData_allcycles$PIRCAT, useNA="ifany")
```


##CycleYr
Check levels of cycle year, make sure they match up with your analysis timespan, and check missingness
```{r}
#cycleyears
table(FullData_allcycles$cycleyr, useNA="ifany")

```


##Phenols
Urinary Bisphenol A - URXBPH
Urinary Bisphenol F - URXBPF
Urinary Bisphenol S - URXBPS
Urinary 2-Hydroxy-4-metoxybenzophenone (Benzophenone-3) - URXBP3
Urinary 2,4,4’-Trichloro-2’-hydroxyphenyl ether (Triclosan) - URXTRS
Urinary Butyl paraben - URXBUP
Urinary Propyl paraben - URXPPB
Urinary Ethyl paraben - URXEPB
Urinary Methyl paraben - URXMPB
```{r}
names(FullData_allcycles)
FullData_allcycles <- FullData_allcycles %>%
  select(-c(URXUCR.x, URXUCR.y))

#BPA
summary(FullData_allcycles$URXBPH, na.rm = FALSE)

#BPF

#BPS

```

Create Sample 2 (final analytic dataset)
```{r}
FullData_allcycles$SAMPLE2 <- FullData_allcycles$SAMPLE

names(FullData_allcycles)#check if variable was created

```



###Outliers

raw column= phenol concentration (ng/mL), flag_column= below or above LOD?  LOD= obtained from NHANES documentation (the doc file on NHANES website. You can use last cycle years doc to fill in these values)
```{r}
# Define metabolites, their raw columns, flag columns, and their respective LOD values
metabolites <- list(
  BPH = list(raw_col = "URXBPH", flag_col = "URDBPHLC", lod = 0.2), #example fill in rest 
  MCPP = list(raw_col = "URXMC1", flag_col = "URDMC1LC", lod = 0.4),
  MEP = list(raw_col = "URXMEP", flag_col = "URDMEPLC", lod = 1.2),
  MHP = list(raw_col = "URXMHP", flag_col = "URDMHPLC", lod = 0.8),
  MIB = list(raw_col = "URXMIB", flag_col = "URDMIBLC", lod = 0.8),
  MZP = list(raw_col = "URXMZP", flag_col = "URDMZPLC", lod = 0.3),
  MHH = list(raw_col = "URXMHH", flag_col = "URDMHHLC", lod = 0.4),
  MOH = list(raw_col = "URXMOH", flag_col = "URDMOHLC", lod = 0.2)
)


# Replace flagged values with LOD/sqrt(2) for all metabolites (LEAVE THIS FUNCTION AND RUN AS IS)
for (metab in names(metabolites)) {
  
  # Extract the columns for raw values, flag columns, and LOD values
  raw_col <- metabolites[[metab]]$raw_col
  flag_col <- metabolites[[metab]]$flag_col
  lod <- metabolites[[metab]]$lod
  
  # Create metabolite column by copying the raw data
  FullData_allcycles[[metab]] <- FullData_allcycles[[raw_col]]
  
  # For flag columns (i.e., below-detection or missing), replace flagged values with LOD/sqrt(2)
  FullData_allcycles[[metab]][FullData_allcycles[[flag_col]] == 1] <- lod / sqrt(2)
  
  # Calculate the standard deviation of the metabolite for complete cases
  metab_sd <- sd(FullData_allcycles[[metab]][FullData_allcycles$SAMPLE == 1], na.rm = TRUE)
  
  # Set outlier cutoff as 5 * SD
  cutoff <- 5 * metab_sd
  
  # Flag outliers (if metabolite value > 5*SD) by setting SAMPLE2 to 0
  FullData_allcycles$SAMPLE2[FullData_allcycles[[metab]] > cutoff] <- 0
  
  # Output some summary statistics for each metabolite
  cat("\n---", metab, "---\n")
  cat("Standard Deviation:", round(metab_sd, 3), "\n")
  cat("5x Standard Deviation Cutoff:", round(cutoff, 3), "\n")
  cat("Number of Outliers (SAMPLE2 = 0):", sum(FullData_allcycles$SAMPLE2 == 0, na.rm = TRUE), "\n")
  cat("Post-Outlier Standard Deviation:", round(sd(FullData_allcycles[[metab]][FullData_allcycles$SAMPLE2 == 1], na.rm = TRUE), 3), "\n")
}

```


###Replace missingness

```{r}
#replace missingness (REPLACE WITH PHENOLS )
FullData_allcycles$SAMPLE2<-ifelse(
  is.na(FullData_allcycles$MEP)|
  is.na(FullData_allcycles$MNBP)|
  is.na(FullData_allcycles$MIB)|
  is.na(FullData_allcycles$MCPP)|
  is.na(FullData_allcycles$MZP)|
  is.na(FullData_allcycles$MHP)|
  is.na(FullData_allcycles$MHH)|
  is.na(FullData_allcycles$MOH),
  0, FullData_allcycles$SAMPLE2
)




#create log transformations now so they are in survey + subesets 

#learning visual look at histogram of normal scale values: 

#MEP (replace with a phenol) 
hist(FullData_allcycles$MEP)


#now log transform and look at the new histogram. You should see difference. 
FullData_allcycles$MEP_LOG<-log(FullData_allcycles$MEP)

hist(FullData_allcycles$MEP_LOG)



#log transform remaining phenols 
FullData_allcycles$MEP_LOG<-log(FullData_allcycles$MEP)
FullData_allcycles$MNBP_LOG<-log(FullData_allcycles$MNBP)
FullData_allcycles$MIB_LOG<-log(FullData_allcycles$MIB)
FullData_allcycles$MCPP_LOG<-log(FullData_allcycles$MCPP)
FullData_allcycles$MZP_LOG<-log(FullData_allcycles$MZP)
FullData_allcycles$MHP_LOG<-log(FullData_allcycles$MHP)
FullData_allcycles$MHH_LOG<-log(FullData_allcycles$MHH)
FullData_allcycles$MOH_LOG<-log(FullData_allcycles$MOH)

```



##Weights
```{r}
#change survey weights 
FullData_allcycles <- FullData_allcycles %>%
  mutate(SURVWEIGHT = case_when(
    cycleyr >= 1 & !is.na(WTMEC2YR) ~ WTMEC2YR * (1 / 10),
    TRUE ~ NA_real_
  ))


write_csv(FullData_allcycles, "Phenols_DataClean/FullData_allcyclesFINAL.csv")

```

