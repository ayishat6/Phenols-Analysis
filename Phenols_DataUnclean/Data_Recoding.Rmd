---
title: "Data_Recoding"
author: "Ayishat Yussuf"
date: "2025-09-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
```
# Load Packages and Datasets

```{r}
library(readr) #read in csv files 
library(survey) #analysis for survey data (e.g NHANES)
library(magrittr) #pip operations (%>%) 
library(dplyr) #data manipulation (filter, select, mutate etc) 
library(ggplot2) #creating data visualizations/plots
```

#Load File
```{r}
FullData_allcycles<-read.csv("~/Documents/Github/Phenols-Analysis/Phenols_DataUnclean/FullData_allcycles.csv")
```

##Food Security
```{r}
#fsdhh
table(FullData_allcycles$FSDHH, useNA="ifany")
#305 missing

#Variables
FullData_allcycles<-FullData_allcycles%>%
  mutate(FOODSEC=case_when(
    FSDHH==1 ~1,  #fully food secure (ref)
    FSDHH==2 ~2, #marginally food secure (1-2)
    FSDHH==3 ~3, # low food security 
    FSDHH==4 ~4,  #very low food security 
    TRUE~NA_real_
  ))

table(FullData_allcycles$FOODSEC,useNA="ifany")
```
Marshae Note to Ayishat: 18,961 adult and child population 
##Age
```{r}
summary(FullData_allcycles$RIDAGEYR, useNA="ifany")

class(FullData_allcycles$RIDAGEYR) #to see what type of variable you have 

FullData_allcycles<-FullData_allcycles%>%
  filter(FullData_allcycles$RIDAGEYR>=18) #filtered for observations Age greater than or equal to 18

quartiles<-quantile(FullData_allcycles$RIDAGEYR)
print(quartiles)

FullData_allcycles$AGEGROUP<-cut(
  FullData_allcycles$RIDAGEYR,
  breaks=quartiles, 
  include.lowest=TRUE, 
  labels= c("18-31", "32-46", "47-63", "64-85")
)

#no missing
table(FullData_allcycles$AGEGROUP, useNA="ifany")
```
decided to keep male as reference - september 19th, 2025

Marshae Note to Ayishat: Following removal of children, sample size is now 13,207

##Sex
```{r}
table(FullData_allcycles$RIAGENDR, useNA="ifany")

FullData_allcycles<-FullData_allcycles%>%
  mutate(SEX=ifelse(RIAGENDR==1, 1, 2))

levels(FullData_allcycles$SEX)<-(c("1", "2"))

table(FullData_allcycles$SEX, useNA="ifany")
```


##Race/Eth
```{r}
#Recode race/ethnicity 
table(FullData_allcycles$RIDRETH1, useNA="ifany")

FullData_allcycles<-FullData_allcycles%>%
  mutate(RACEETH=case_when(
    RIDRETH1==3 ~1,
    RIDRETH1==4 ~2, 
    RIDRETH1==1 ~3, 
    RIDRETH1==2 ~4, 
    RIDRETH1==5 ~5, 
    TRUE~NA_real_
  ))


table(FullData_allcycles$RACEETH, useNA="ifany")
```


##Education
```{r}
#education 
summary(FullData_allcycles$DMDEDUC3)
summary(FullData_allcycles$DMDEDUC3)
FullData_allcycles <- FullData_allcycles %>%
  mutate(EDUCAT = case_when(
   DMDEDUC3< 13 & RIDAGEYR<20 ~ 1,
    DMDEDUC2 < 3 ~ 1, 
    DMDEDUC2== 1 ~2, 
    DMDEDUC3 %in% c(13, 14, 15) ~ 2, 
    DMDEDUC2 == 3 ~ 2,
    DMDEDUC2 == 4 ~ 3,
    DMDEDUC2 == 5 ~ 4,
    TRUE ~ NA_real_
  ))

table(FullData_allcycles$EDUCAT, useNA="ifany")
```


##Poverty
```{r}
#poverty
summary(FullData_allcycles$INDFMPIR, useNA="ifany") #1513missing

FullData_allcycles<-FullData_allcycles%>%
  mutate(PIRCAT=case_when(
    INDFMPIR<=0.99 ~1, 
    INDFMPIR>=1 & INDFMPIR<2 ~2, 
    INDFMPIR>=2 & INDFMPIR<3 ~3, 
    INDFMPIR>=3 & INDFMPIR<5 ~4, 
    INDFMPIR>=5 ~5, 
    is.na(INDFMPIR)~NA_real_
  ))

table(FullData_allcycles$PIRCAT, useNA="ifany")
```


##CycleYr
Check levels of cycle year, make sure they match up with your analysis time span, and check missingness
```{r}
#cycleyears
table(FullData_allcycles$cycleyr, useNA="ifany")

```


##Phenols
Urinary Bisphenol A - URXBPH
Urinary Bisphenol F - URXBPF
Urinary Bisphenol S - URXBPS
Urinary 2-Hydroxy-4-metoxybenzophenone (Benzophenone-3) - URXBP3
Urinary 2,4,4’-Trichloro-2’-hydroxyphenyl ether (Triclosan) - URXTRS
Urinary Butyl paraben - URXBUP
Urinary Propyl paraben - URXPPB
Urinary Ethyl paraben - URXEPB
Urinary Methyl paraben - URXMPB
```{r}
names(FullData_allcycles)
FullData_allcycles <- FullData_allcycles %>%
  select(-c(URXUCR.x, URXUCR.y))

#BPH
summary(FullData_allcycles$URXBPH, na.rm = FALSE) #450 missing
##BPF
#summary(FullData_allcycles$URXBPF, na.rm = FALSE) #9506 missing
##BPS
#summary(FullData_allcycles$URXBPS, na.rm = FALSE)  #9506 missing
#BP3
summary(FullData_allcycles$URXBP3, na.rm = FALSE) #450 missing
#TRS
summary(FullData_allcycles$URXTRS, na.rm = FALSE) #2115 missing
#BUP
summary(FullData_allcycles$URXBUP, na.rm = FALSE) #2115 missing
#EPB
summary(FullData_allcycles$URXEPB, na.rm = FALSE) #2115 missing
#MPB
summary(FullData_allcycles$URXMPB, na.rm = FALSE) #2115 missing
#PPB
summary(FullData_allcycles$URXPPB, na.rm = FALSE) #2115 missing
```

###Create Sample and Sample 2 (final analytic dataset)

Marshae Note to Ayishat: Before we generate sample: prior to any missingness removal we have 13207 participants
```{r}

#generate sample (samplepopulation) from nonmissing in exposure/covariates
FullData_allcycles<-FullData_allcycles %>%
  mutate(SAMPLE= ifelse(is.na(EDUCAT)| is.na(PIRCAT) | is.na(SEX)| is.na(RACEETH) | is.na(AGEGROUP)| is.na(FOODSEC) | cycleyr==1,0,1))

#if any of these are missing give it a zero OR from cycleyr 1, if not give it a 1. 

summary(FullData_allcycles$SAMPLE)
table(FullData_allcycles$SAMPLE, useNA="ifany") #10,423

#second sampling variable (missing in outcome, creatinine)
FullData_allcycles$SAMPLE2<- FullData_allcycles$SAMPLE

names(FullData_allcycles)#check if variable was created

saveRDS(FullData_allcycles, "FullData_allcycles.rds") #run this to save dataset with changes/recoding 


```
Following removal we have 10,423 with exclusion of missing covariates, and exposure data


###Outliers

raw column= phenol concentration (ng/mL), flag_column= below or above LOD?  LOD= obtained from NHANES documentation (the doc file on NHANES website. You can use last cycle years doc to fill in these values)

Urinary Bisphenol A - URXBPH
Urinary Bisphenol F - URXBPF--EXCLUDE (10/8/25)
Urinary Bisphenol S - URXBPS --EXCLUDE (10/8/25)
Urinary 2-Hydroxy-4-metoxybenzophenone (Benzophenone-3) - URXBP3
Urinary 2,4,4’-Trichloro-2’-hydroxyphenyl ether (Triclosan) - URXTRS
Urinary Butyl paraben - URXBUP
Urinary Propyl paraben - URXPPB
Urinary Ethyl paraben - URXEPB
Urinary Methyl paraben - URXMPB

Missingness schema for outcome/creatinine, 
Remove those who have missing data
Remove those who are outliers (5 standard deviations above the mean)


*MARSHAE NOTES TO AYISHAT: 
--2003-2004: BPA, Triclsoan, BP3
--2005-2006: Phenols + Parabens (introduced this year): BPA, BP3, Triclosan, Methyl, Ethyl, Propyl, Butyl Paraben 

Decision: Too restrictive in list previous list. 
Will start from 2005-2005 and only include: 
  BPA, BP3, Triclosan, Butyl, Ethyl, Methyl, Propyl Parabens
```{r}
FullData_allcycles<-readRDS("FullData_allcycles.rds")

# Define metabolites, their raw columns, flag columns, and their respective LOD values
metabolites <- list(
  BPH = list(raw_col = "URXBPH", flag_col = "URDBPHLC", lod = 0.2), 
  #BPF = list(raw_col = "URXBPF", flag_col = "URDBPFLC", lod = 0.2),
  #BPS = list(raw_col = "URXBPS", flag_col = "URDBPSLC", lod = 0.1),
  BP3 = list(raw_col = "URXBP3", flag_col = "URDBP3LC", lod = 0.4),
  TRS = list(raw_col = "URXTRS", flag_col = "URDTRSLC", lod = 1.7),
  BUP = list(raw_col = "URXBUP", flag_col = "URDBUPLC", lod = 0.1),
  EPB = list(raw_col = "URXEPB", flag_col = "URDEPBLC", lod = 1.0),
  MPB = list(raw_col = "URXMPB", flag_col = "URDMPBLC", lod = 1.0),
  PPB = list (raw_col = "URXPPB", flag_col = "URDPPBLC", lod = 0.1)
)

# Replace flagged values with LOD/sqrt(2) for all metabolites (LEAVE THIS FUNCTION AND RUN AS IS)
for (metab in names(metabolites)) {
  
  # Extract the columns for raw values, flag columns, and LOD values
  raw_col <- metabolites[[metab]]$raw_col
  flag_col <- metabolites[[metab]]$flag_col
  lod <- metabolites[[metab]]$lod
  
  # Create metabolite column by copying the raw data
  FullData_allcycles[[metab]] <- FullData_allcycles[[raw_col]]
  
  # For flag columns (i.e., below-detection or missing), replace flagged values with LOD/sqrt(2)
  FullData_allcycles[[metab]][FullData_allcycles[[flag_col]] == 1] <- lod / sqrt(2)
  
  # Calculate the standard deviation of the metabolite for complete cases (nonmissingexposure/covariatesetc)
  metab_sd <- sd(FullData_allcycles[[metab]][FullData_allcycles$SAMPLE == 1], na.rm = TRUE)
  
  # Set outlier cutoff as 5 * SD
  cutoff <- 5 * metab_sd
  
  # Flag outliers (if metabolite value > 5*SD) by setting SAMPLE2 to 0
  FullData_allcycles$SAMPLE2[FullData_allcycles[[metab]] > cutoff] <- 0
  
  # Output some summary statistics for each metabolite
  cat("\n---", metab, "---\n")
  cat("Standard Deviation:", round(metab_sd, 3), "\n")
  cat("5x Standard Deviation Cutoff:", round(cutoff, 3), "\n")
  cat("Number of Outliers (SAMPLE2 = 0):", sum(FullData_allcycles$SAMPLE2 == 0, na.rm = TRUE), "\n")
  cat("Post-Outlier Standard Deviation:", round(sd(FullData_allcycles[[metab]][FullData_allcycles$SAMPLE2 == 1], na.rm = TRUE), 3), "\n")
}

```

*Marshae Note to self: 
The detection limits were constant for all of the analytes in the data set. Two variables are provided for each of these analytes. The variable name ending in “LC” (ex., URDBPHLC) indicates whether the result was below the limit of detection: the value “0” means that the result was at or above the limit of detection, “1” indicates that the result was below the limit of detection. For analytes with analytic results below the lower limit of detection (ex., URDBPHLC=1), an imputed fill value was placed in the analyte results field. This value is the lower limit of detection divided by square root of 2 (LLOD/sqrt[2]). The other variable prefixed URX (ex., URXBPH) provides the analytic result for that analyte.---2015/2016 documentation NHANES




###Replace missingness

```{r}

#replace missingness (REPLACE WITH PHENOLS )
FullData_allcycles$SAMPLE2<-ifelse(
  is.na(FullData_allcycles$BPH)|
  is.na(FullData_allcycles$BP3)|
  is.na(FullData_allcycles$TRS)|
  is.na(FullData_allcycles$BUP)|
  is.na(FullData_allcycles$EPB)|
  is.na(FullData_allcycles$PPB)|  
  is.na(FullData_allcycles$MPB),
  0, FullData_allcycles$SAMPLE2
)

table(FullData_allcycles$SAMPLE2, useNA = "ifany") #9,624 participants, 3528 were removed, none missing


```
Marshae note to Ayishat: #9,758 participants, 3449 were removed

###LOG Transformations

```{r}
# 1. Remove existing BPH_LOG column if it exists
FullData_allcycles$BPH_LOG <- NULL

# 2. Calculate means and SD for thresholding
mu <- mean(FullData_allcycles$BPH, na.rm = TRUE)
sigma <- sd(FullData_allcycles$BPH, na.rm = TRUE)

# 3. Subset data for 5 SD and 3 SD
bph_5sd <- FullData_allcycles[ FullData_allcycles$BPH < (mu + 5*sigma), ]
bph_3sd <- FullData_allcycles[ FullData_allcycles$BPH < (mu + 3*sigma), ]

# 4. Log transform in each subset
bph_5sd$BPH_LOG <- log(bph_5sd$BPH)
bph_3sd$BPH_LOG <- log(bph_3sd$BPH)

# 5. Plot histograms side by side for direct comparison
par(mfrow = c(1,2))
hist(bph_5sd$BPH_LOG, breaks = 100,
     main = "Histogram log(BPH), <5 SD",
     xlab = "log(BPH) (5 SD cut)")
hist(bph_3sd$BPH_LOG, breaks = 100,
     main = "Histogram log(BPH), <3 SD",
     xlab = "log(BPH) (3 SD cut)")
par(mfrow = c(1,1))
```


```{r}
hist(log(FullData_allcycles$TRS[FullData_allcycles$SAMPLE2 == 1]), breaks=100)
```

```{r}
#create log transformations now so they are in survey + subesets 

#learning visual look at histogram of normal scale values: 

table(FullData_allcycles$BPH == 0)  #none        # How many zeros?
table(FullData_allcycles$BPH < 0)    #none       # Any negatives?
summary(FullData_allcycles$BPH)             # Full summary

mu <- mean(FullData_allcycles$BPH_LOG, na.rm=TRUE)
sigma <- sd(FullData_allcycles$BPH_LOG, na.rm=TRUE)
# Keep only those within 3 SD:
FullData_allcycles_no_outliers <- subset(
  FullData_allcycles,
  BPH_LOG < (mu + 3*sigma) & BPH_LOG > (mu - 3*sigma)
)

#BPH
hist(FullData_allcycles$BPH, breaks=100)
#now log transform and look at the new histogram. You should see difference. 
FullData_allcycles$BPH_LOG<-log(FullData_allcycles$BPH)

hist(FullData_allcycles$BPH_LOG,breaks=100)

#BP3
hist(FullData_allcycles$BP3)
FullData_allcycles$BP3_LOG<-log(FullData_allcycles$BP3)
hist(FullData_allcycles$BP3_LOG)

#BPF
hist(FullData_allcycles$BPF)
FullData_allcycles$BPF_LOG<-log(FullData_allcycles$BPF)
hist(FullData_allcycles$BPF_LOG)

#BPS
hist(FullData_allcycles$BPS)
FullData_allcycles$BPS_LOG<-log(FullData_allcycles$BPS)
hist(FullData_allcycles$BPS_LOG)

#TRS
hist(FullData_allcycles$TRS)
FullData_allcycles$TRS_LOG<-log(FullData_allcycles$TRS)
hist(FullData_allcycles$TRS_LOG)

#BUP
hist(FullData_allcycles$BUP)
FullData_allcycles$BUP_LOG<-log(FullData_allcycles$BUP)
hist(FullData_allcycles$BUP_LOG)

#EPB
hist(FullData_allcycles$EPB)
FullData_allcycles$EPB_LOG<-log(FullData_allcycles$EPB)
hist(FullData_allcycles$EPB_LOG)

#MPB
hist(FullData_allcycles$MPB)
FullData_allcycles$MPB_LOG<-log(FullData_allcycles$MPB)
hist(FullData_allcycles$MPB_LOG)

#PPB
hist(FullData_allcycles$PPB)
FullData_allcycles$PPB_LOG<-log(FullData_allcycles$PPB)
hist(FullData_allcycles$PPB_LOG)


```


##Weights
```{r}
#change survey weights 
FullData_allcycles <- FullData_allcycles %>%
  mutate(SURVWEIGHT = case_when(
    cycleyr >= 1 & !is.na(WTSC2YR) ~ WTSC2YR * (1 / 7),
    cycleyr >= 2 & !is.na(WTSB2YR) ~ WTSB2YR * (1 / 7),
    cycleyr >= 3 & !is.na(WTSB2YR) ~ WTSB2YR * (1 / 7),
    cycleyr >= 4 & !is.na(WTSB2YR) ~ WTSB2YR * (1 / 7),
    cycleyr >= 5 & !is.na(WTSA2YR) ~ WTSA2YR * (1 / 7),
    cycleyr >= 6 & !is.na(WTSB2YR) ~ WTSB2YR * (1 / 7),
    cycleyr >= 7 & !is.na(WTSB2YR) ~ WTSB2YR * (1 / 7),
    TRUE ~ NA_real_
  ))


write_csv(FullData_allcycles, "~/Documents/Github/Phenols-Analysis/Phenols_DataClean/FullData_allcyclesFINAL.csv")

saveRDS(FullData_allcycles, "~/Documents/Github/Phenols-Analysis/Phenols_DataClean/FullData_allcyclesFINAL.rds")
```

```{r}
summary(FullData_allcycles$SDMVPSU)
```

